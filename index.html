<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>FlÃ¥m Guide 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#2A5B87" />
    <meta name="description" content="GuÃ­a turÃ­stica interactiva para FlÃ¥m 2026" />
    
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhcA0a_MFgQpkEks6XXvRI9ekfq5qrYfMtxOG8HuGchmFveZ0yYGSKmg1MXKNRAw8Snc-ZD5iHimhmGEv9YBd9jNhcoLoYAK7eVaxEab_NF3R3TXQcmCYtn5eFD34tQxs5j1yUiD9s0MKmdVTKi4iVZPC4AwCqhkntHp9vkeKC-Kj4q47VsePLnxWbY1_g/s2048/Gemini_Generated_Image_5e2y1u5e2y1u5e2y.png" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              fjord: { 50:'#f0f9ff', 100:'#e0f2fe', 500:'#2A5B87', 600:'#0284c7', 900:'#0c4a6e' },
              mountain: { 500:'#3A7D44' },
              sunset: { 500:'#FFB347' }
            },
            fontFamily: { sans: ['Roboto Condensed', 'sans-serif'] }
          }
        }
      }
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map (LIMPIO, SIN RECHARTS NI REACT 19) -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "recharts": "https://aistudiocdn.com/recharts@^3.5.1",
    "leaflet": "https://aistudiocdn.com/leaflet@^1.9.4"
  }
}
</script>
    
    <!-- Leaflet JS Global -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { background-color: #f8fafc; overscroll-behavior-y: none; }
        .leaflet-container { width: 100%; height: 100%; z-index: 0; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content { animation: fadeIn 0.2s ease-out forwards; }
        
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .active-card { animation: pulse-border 2s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { CalendarClock, Map as MapIcon, Wallet, BookOpen, Anchor, CheckCircle2, Circle, MapPin, AlertTriangle, Clock, ArrowRight, TrendingDown, Info, AlertCircle, ShoppingBag, Volume2, Camera, CloudSun, Wind, Droplets, Umbrella, X, Eye, Lightbulb, ChevronDown, Ticket, Zap, Calculator, ArrowRightLeft, RefreshCw, Languages, Utensils, Instagram, CloudRain, CloudSnow, Sun, Smartphone, Sunrise, Sunset } from 'lucide-react';

        // --- CONSTANTS ---
        const SHIP_DEPARTURE_TIME = "18:00";
        const ONBOARD_TIME = "17:45";
        const UPDATE_DATE = "04 de diciembre de 2025";
        
        const COORDS = {
            FLAM_DOCK: { lat: 60.8638, lng: 7.1187 },
            FLAM_STATION: { lat: 60.8632, lng: 7.1145 },
            MYRDAL: { lat: 60.7353, lng: 7.1226 },
            AEGIR_PUB: { lat: 60.8638, lng: 7.1172 },
            GUDVANGEN: { lat: 60.8812, lng: 6.8413 },
            STEGASTEIN_VIEWPOINT: { lat: 60.9085, lng: 7.2123 },
            VISITOR_CENTER: { lat: 60.8622, lng: 7.1115 }
        };

        const INITIAL_ITINERARY = [
            {
                id: '1', title: 'Llegada a Puerto', startTime: '07:00', endTime: '07:15',
                locationName: 'Fiordo de Aurlandsfjord', coords: COORDS.FLAM_DOCK,
                description: 'El MSC Euribia atraca en el puerto de FlÃ¥m.',
                fullDescription: 'Disfruta de las vistas de la llegada navegando por el fiordo antes de atracar. El barco inicia maniobras de atraque.',
                tips: 'Sube a cubierta para ver la aproximaciÃ³n al fiordo. Es espectacular.',
                keyDetails: 'Hora de llegada oficial.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false
            },
            {
                id: '2', title: 'Desayuno Buffet "Marketplace"', startTime: '07:15', endTime: '07:45',
                locationName: 'MSC Euribia', coords: COORDS.FLAM_DOCK,
                description: 'Carga energÃ­a antes de bajar.',
                fullDescription: 'Desayuno completo en el buffet Marketplace del barco antes de iniciar la excursiÃ³n.',
                tips: 'Come bien, el almuerzo en el pub es hasta las 10:40. Lleva agua.',
                keyDetails: 'Buffet abierto.',
                priceNOK: 0, priceEUR: 0, type: 'food', completed: false
            },
            {
                id: '3', title: 'Desembarque y OrientaciÃ³n', startTime: '08:00', endTime: '08:15',
                locationName: 'Muelle de Cruceros', coords: COORDS.FLAM_DOCK,
                description: 'Bajada del barco y camino a la estaciÃ³n.',
                fullDescription: 'FlÃ¥m estarÃ¡ fresco. Baja del barco y dirÃ­gete directamente a la estaciÃ³n de tren (a 200m).',
                tips: 'Aprovecha para sacar fotos del barco y el fiordo en la luz de la maÃ±ana. Es el mejor momento para fotos sin multitudes.',
                keyDetails: 'Webcam en vivo disponible.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false, notes: 'Webcam disponible',
                webcamUrl: 'https://www.norwaysbest.com/es/flam/webcam-de-flam',
                instagramUrl: 'https://www.instagram.com/explore/tags/flam/'
            },
            {
                id: '4', title: 'El Tren (FlÃ¥msbana)', startTime: '08:20', endTime: '10:28',
                locationName: 'EstaciÃ³n de FlÃ¥m', endLocationName: 'EstaciÃ³n Myrdal',
                coords: COORDS.FLAM_STATION, endCoords: COORDS.MYRDAL,
                description: 'Considerado uno de los viajes en tren mÃ¡s bonitos del mundo.',
                fullDescription: 'Considerado uno de los viajes en tren mÃ¡s bonitos del mundo. SubirÃ¡s desde el nivel del mar hasta 867 metros. VerÃ¡s la cascada Kjosfossen (donde el tren para fotos) y valles profundos.',
                tips: 'Â¡Toma el primer tren! EstarÃ¡s en Myrdal antes de que lleguen otros cruceros.\n\nâ­ ASIENTOS: LADO IZQUIERDO SUBIDA â€“ LADO DERECHO BAJADA.',
                keyDetails: 'Ida y vuelta (~2 horas).',
                priceNOK: 800, priceEUR: 70, type: 'transport', completed: false, notes: 'Parada en cascada Kjosfossen',
                ticketUrl: 'https://www.norwaysbest.com/es/actividades/el-tren-de-flam',
                instagramUrl: 'https://www.instagram.com/explore/tags/flamsbana/'
            },
            {
                id: '5', title: 'Bebida en Ã†gir BrewPub', startTime: '10:40', endTime: '11:40',
                locationName: 'Ã†gir BrewPub', coords: COORDS.AEGIR_PUB,
                description: 'Edificio vikingo con chimenea de 9 metros.',
                fullDescription: 'Un edificio inspirado en la mitologÃ­a nÃ³rdica, con arquitectura de madera flotante, cabezas de dragÃ³n y una impresionante chimenea central de 9 metros de altura.',
                tips: 'Â¡Tiempo para el festÃ­n! Disfruta de la chimenea y el ambiente vikingo antes del barco.',
                keyDetails: 'Bebida en el pub vikingo (segÃºn presupuesto).',
                priceNOK: 80, priceEUR: 8.50, type: 'food', completed: false,
                ticketUrl: 'https://www.google.com/search?q=https://www.flamsbrygga.no/en/aegir-brewpub/&authuser=1',
                instagramUrl: 'https://www.instagram.com/explore/tags/aegirbrewpub/'
            },
            {
                id: '6', title: 'Fjord Cruise + Bus', startTime: '12:00', endTime: '14:30',
                locationName: 'Puerto FlÃ¥m', endLocationName: 'Gudvangen',
                coords: COORDS.FLAM_DOCK, endCoords: COORDS.GUDVANGEN,
                description: 'NavegarÃ¡s por el NÃ¦rÃ¸yfjord (UNESCO).',
                fullDescription: 'NavegarÃ¡s por el NÃ¦rÃ¸yfjord (Patrimonio UNESCO). Es la parte mÃ¡s estrecha y espectacular del fiordo, con cascadas y granjas aisladas en las laderas.',
                tips: 'LogÃ­stica: Toma la salida del barco elÃ©ctrico a las 12:00. Navegas FlÃ¥m â†’ Gudvangen, y tomas el bus de vuelta (shuttle incluido en el ticket) a FlÃ¥m.',
                keyDetails: 'DuraciÃ³n total 2.5 horas.',
                priceNOK: 950, priceEUR: 85, type: 'sightseeing', completed: false,
                ticketUrl: 'https://www.norwaysbest.com/es/flam/actividades/crucero-por-el-fiordo-naeroyfjord',
                instagramUrl: 'https://www.instagram.com/explore/tags/nÃ¦rÃ¸yfjord/'
            },
            {
                id: '7', title: 'Mirador Stegastein', startTime: '15:00', endTime: '16:30',
                locationName: 'Parada Bus FlÃ¥m', endLocationName: 'Mirador Stegastein',
                coords: COORDS.FLAM_STATION, endCoords: COORDS.STEGASTEIN_VIEWPOINT,
                description: 'Plataforma a 650m sobre el fiordo.',
                fullDescription: 'Una plataforma de acero y madera que sobresale 30 metros de la montaÃ±a y cuelga a 650 metros sobre el fiordo con un panel frontal de cristal Ãºnico.',
                tips: 'Toma el bus a las 15:00. VolverÃ¡s con las espectaculares luces del atardecer primaveral sobre el fiordo.',
                keyDetails: 'Tour en bus ida y vuelta.',
                priceNOK: 450, priceEUR: 40, type: 'sightseeing', completed: false,
                ticketUrl: 'https://www.norwaysbest.com/es/flam/actividades/mirador-stegastein',
                instagramUrl: 'https://www.instagram.com/explore/tags/stegastein/'
            },
            {
                id: '8', title: 'Compras y Relax', startTime: '16:30', endTime: '17:30',
                locationName: 'Centro de Visitantes', coords: COORDS.VISITOR_CENTER,
                description: 'Tiendas de souvenirs y artesanÃ­as.',
                fullDescription: 'Tiendas de souvenirs con suÃ©teres de lana noruega autÃ©ntica y artesanÃ­as locales.',
                tips: 'Â¡Nuevo! Una hora completa para el paseo sin prisas gracias a la hora extra. Ãšltimo cafÃ© o souvenir.',
                keyDetails: 'Relajado, sin prisa.',
                priceNOK: 0, priceEUR: 0, type: 'shopping', completed: false
            },
            {
                id: '9', title: 'Caminata Final al Barco', startTime: '17:30', endTime: '17:45',
                locationName: 'Centro -> Muelle', coords: COORDS.FLAM_DOCK,
                description: 'Traslado tranquilo al muelle.',
                fullDescription: 'Comienza a moverte tranquilamente hacia el muelle para el embarque.',
                tips: 'Advertencia: No apures el tiempo. Es el momento de volver.',
                keyDetails: '15 min de caminata.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false
            },
            {
                id: '10', title: 'Â¡A BORDO! (LÃ­mite 17:45)', startTime: '17:45', endTime: '18:00',
                locationName: 'Muelle', coords: COORDS.FLAM_DOCK,
                description: 'Pasarela se retira 17:45. Zarpe 18:00.',
                fullDescription: 'Regreso obligatorio al barco. A las 17:45 se retira la pasarela. A las 18:00 el barco inicia la maniobra de salida.',
                tips: 'Â¡ADVERTENCIA! No llegues tarde. Hora lÃ­mite absoluta para embarcar: 17:45.',
                keyDetails: 'CRÃTICO: SALIDA DEL BARCO 18:00.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false, notes: 'CRITICAL'
            }
        ];

        const PRONUNCIATIONS = [
            { word: 'FlÃ¥m', phonetic: '/floËm/', simplified: 'FLOUM', meaning: 'Llanura pequeÃ±a' },
            { word: 'FlÃ¥msbana', phonetic: '/flÉ”msbÉ‘ËnÉ‘/', simplified: 'FLOM-baana', meaning: 'Tren de FlÃ¥m' },
            { word: 'Myrdal', phonetic: '/myËrdÉ‘l/', simplified: 'MÃœR-dal', meaning: 'Valle pantanoso' },
            { word: 'Ã†gir', phonetic: '/ËˆÉ›ËjiÉ¾/', simplified: 'Ã‰G-uir', meaning: 'Gigante del mar' },
            { word: 'NÃ¦rÃ¸yfjord', phonetic: '/ËˆnÉ›ËrÅ“ÉªfjÉ”r/', simplified: 'NEHR-oy-fiuord', meaning: 'Fiordo estrecho' },
            { word: 'Stegastein', phonetic: '/ËˆstÉ›gÉ‘stÉ‘Éªn/', simplified: 'STÃ‰-ga-stain', meaning: 'Piedra del sendero' },
            { word: 'Gudvangen', phonetic: '/ËˆgÊ‰dÊ‹É‘Å‹É™n/', simplified: 'GÃœD-vang-en', meaning: 'Campo de los dioses' },
            { word: 'Takk', phonetic: '/tak/', simplified: 'TAK', meaning: 'Gracias' },
        ];

        // --- UTILS ---
        const calculateDistance = (c1, c2) => {
            if(!c1 || !c2) return 0;
            const R = 6371e3; 
            const Ï†1 = c1.lat * Math.PI/180;
            const Ï†2 = c2.lat * Math.PI/180;
            const Î”Ï† = (c2.lat-c1.lat) * Math.PI/180;
            const Î”Î» = (c2.lng-c1.lng) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2)*Math.sin(Î”Ï†/2) + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)*Math.sin(Î”Î»/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        };

        const formatDistance = (meters) => {
            if (meters < 1000) return `${Math.round(meters)} m`;
            return `${(meters / 1000).toFixed(1)} km`;
        };

        const calculateDuration = (start, end) => {
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            let diff = (eh*60+em) - (sh*60+sm);
            if(diff < 0) diff += 24*60;
            const h = Math.floor(diff/60);
            const m = diff%60;
            return h > 0 && m > 0 ? `${h}h ${m}m` : (h > 0 ? `${h}h` : `${m} min`);
        };

        const formatTimeRemaining = (targetTimeStr) => {
            const now = new Date();
            const [h, m] = targetTimeStr.split(':').map(Number);
            const target = new Date(now); target.setHours(h, m, 0, 0);
            if(target < now) return "Terminado";
            const diffMs = target - now;
            const dh = Math.floor(diffMs/(1000*60*60));
            const dm = Math.floor((diffMs%(1000*60*60))/(1000*60));
            return dh > 0 ? `${dh}h ${dm}m` : `${dm}m`;
        };

        // --- COMPONENTS ---
        const ActivityDetailModal = ({ activity, onClose }) => {
            if (!activity) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-content relative flex flex-col max-h-[85vh]" onClick={e => e.stopPropagation()}>
                        <div className="bg-fjord-600 p-4 text-white relative">
                            <button onClick={onClose} className="absolute top-4 right-4 p-1 bg-white/20 rounded-full hover:bg-white/30">
                                <X size={20} />
                            </button>
                            <h2 className="text-xl font-bold pr-8 leading-tight">{activity.title}</h2>
                            <div className="flex items-center space-x-2 mt-2 text-fjord-100 text-sm font-medium">
                                <Clock size={16} />
                                <span>{activity.startTime} - {activity.endTime}</span>
                            </div>
                        </div>

                        <div className="p-6 overflow-y-auto">
                            <div className="mb-6">
                                <h3 className="flex items-center text-fjord-600 font-bold mb-2 uppercase text-sm tracking-wider">
                                    <Eye size={18} className="mr-2" /> QuÃ© veremos
                                </h3>
                                <p className="text-gray-700 leading-relaxed text-[15px]">
                                    {activity.fullDescription || activity.description}
                                </p>
                            </div>

                            <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
                                <h3 className="flex items-center text-amber-700 font-bold mb-2 uppercase text-sm tracking-wider">
                                    <Lightbulb size={18} className="mr-2" /> Claves y Consejos
                                </h3>
                                <p className="text-gray-800 text-sm whitespace-pre-line leading-relaxed">
                                    {activity.tips || activity.keyDetails}
                                </p>
                            </div>

                            <div className="flex flex-col space-y-2 text-sm text-gray-500 mb-4">
                                <div className="flex items-center">
                                    <MapPin size={16} className="text-fjord-500 mr-2" />
                                    <span className="font-semibold text-gray-700">Inicio:</span>
                                    <span className="ml-1">{activity.locationName}</span>
                                </div>
                                {activity.endLocationName && (
                                    <div className="flex items-center">
                                        <MapPin size={16} className="text-mountain-500 mr-2" />
                                        <span className="font-semibold text-gray-700">Fin:</span>
                                        <span className="ml-1">{activity.endLocationName}</span>
                                    </div>
                                )}
                            </div>

                            <div className="space-y-3 mt-4">
                                {activity.ticketUrl && (
                                    <a href={activity.ticketUrl} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center w-full py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-md hover:bg-emerald-700 active:scale-95 transition-all">
                                        <Ticket size={20} className="mr-2" />
                                        Comprar Tickets Online
                                    </a>
                                )}
                                {activity.webcamUrl && (
                                    <a href={activity.webcamUrl} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center w-full py-3 bg-red-50 text-red-600 rounded-xl font-bold border border-red-100 hover:bg-red-100">
                                        <Camera size={18} className="mr-2" />
                                        Ver Webcam en Vivo
                                    </a>
                                )}
                                {activity.instagramUrl && (
                                    <a href={activity.instagramUrl} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center w-full py-3 bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 text-white rounded-xl font-bold shadow-md hover:opacity-90 active:scale-95 transition-all">
                                        <Instagram size={20} className="mr-2" />
                                        Fotos en Instagram
                                    </a>
                                )}
                            </div>
                        </div>

                        <div className="p-4 border-t border-gray-100 bg-gray-50">
                            <button onClick={onClose} className="w-full py-3 bg-fjord-600 text-white rounded-xl font-bold shadow-md active:scale-95 transition-transform">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Timeline = ({ itinerary, onToggleComplete, onLocate, userLocation }) => {
            const [selectedActivity, setSelectedActivity] = useState(null);
            const [now, setNow] = useState(new Date());

            useEffect(() => {
                const interval = setInterval(() => setNow(new Date()), 60000);
                return () => clearInterval(interval);
            }, []);

            const getMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };

            const currentMinutes = now.getHours() * 60 + now.getMinutes();

            return (
                <div className="pb-24 px-4 pt-4 max-w-lg mx-auto">
                    <h2 className="text-2xl font-bold text-fjord-500 mb-6">Itinerario Lujo Matutino</h2>
                    <div className="relative border-l-2 border-fjord-200 ml-3">
                        {itinerary.map((act, index) => {
                            const duration = calculateDuration(act.startTime, act.endTime);
                            const isCritical = act.notes === 'CRITICAL';
                            const dist = userLocation ? calculateDistance(userLocation, act.coords) : null;
                            const startMins = getMinutes(act.startTime);
                            const endMins = getMinutes(act.endTime);
                            const isActive = currentMinutes >= startMins && currentMinutes < endMins;
                            const totalDurationMins = endMins - startMins;
                            const elapsedMins = currentMinutes - startMins;
                            const progressPercent = isActive ? Math.min(100, Math.max(0, (elapsedMins / totalDurationMins) * 100)) : 0;

                            let bufferElement = null;
                            let nowMarker = null;

                            if (index > 0) {
                                const prev = itinerary[index - 1];
                                const prevEndMins = getMinutes(prev.endTime);
                                const diff = startMins - prevEndMins;
                                if (diff > 0) {
                                     const h = Math.floor(diff/60);
                                     const m = diff%60;
                                     const label = h > 0 ? `${h}h ${m}m` : `${m} min`;
                                     bufferElement = (
                                        <div className="ml-6 mb-6 flex items-center">
                                            <div className="absolute -left-[6px] w-3 h-3 bg-slate-300 rounded-full border-2 border-white"></div>
                                            <span className="text-xs font-bold text-slate-500 bg-slate-50 px-2 py-1 rounded-full border border-slate-200 flex items-center shadow-sm">
                                                <ChevronDown size={14} className="mr-1 text-slate-400" />
                                                {label} traslado/libre
                                            </span>
                                        </div>
                                     );
                                } else {
                                    bufferElement = <div className="h-6"></div>;
                                }

                                if (currentMinutes > prevEndMins && currentMinutes < startMins) {
                                    nowMarker = (
                                        <div className="ml-6 mb-6 flex items-center animate-pulse">
                                            <div className="absolute -left-[5px] w-2.5 h-2.5 bg-red-500 rounded-full ring-4 ring-red-100"></div>
                                            <div className="w-full h-[2px] bg-red-500 ml-2 relative">
                                                <span className="absolute -top-3 left-2 text-[10px] font-bold text-red-600 bg-white px-1">
                                                    ðŸ•’ AHORA {now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                </span>
                                            </div>
                                        </div>
                                    );
                                }
                            } else {
                                if (currentMinutes < startMins) {
                                     nowMarker = (
                                        <div className="ml-6 mb-6 flex items-center">
                                            <div className="absolute -left-[5px] w-2.5 h-2.5 bg-red-500 rounded-full"></div>
                                            <span className="text-xs font-bold text-red-500 ml-2 bg-red-50 px-2 py-0.5 rounded">
                                                ðŸ•’ Esperando inicio ({now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})})
                                            </span>
                                        </div>
                                     );
                                }
                            }

                            return (
                                <React.Fragment key={act.id}>
                                    {bufferElement}
                                    {nowMarker}
                                    
                                    <div className="mb-6 ml-6 relative">
                                        <div className={`absolute -left-[31px] top-0 rounded-full bg-white border-2 cursor-pointer z-10 transition-colors ${
                                            isActive ? 'border-blue-500 text-blue-500 ring-4 ring-blue-100' :
                                            (act.completed ? 'border-emerald-500 text-emerald-500' : 'border-fjord-500 text-fjord-500')
                                        }`} onClick={(e) => { e.stopPropagation(); onToggleComplete(act.id); }}>
                                            {act.completed ? <CheckCircle2 size={24} /> : <Circle size={24} />}
                                        </div>
                                        
                                        <div 
                                            className={`p-4 rounded-lg border shadow-sm transition-all cursor-pointer active:scale-[0.98] 
                                                ${isActive ? 'active-card bg-white border-blue-500 ring-1 ring-blue-200 shadow-lg' : 
                                                (act.completed ? 'bg-emerald-50 border-emerald-500' : 
                                                (isCritical ? 'bg-red-50 border-red-500' : 'bg-white border-fjord-100 hover:shadow-md'))}
                                            `}
                                            onClick={() => setSelectedActivity(act)}
                                        >
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <div className="flex items-center space-x-2 mb-1">
                                                        <span className={`px-2 py-0.5 rounded text-xs font-bold ${isActive ? 'bg-blue-600 text-white' : 'bg-fjord-100 text-fjord-700'}`}>
                                                            {act.startTime} - {act.endTime}
                                                        </span>
                                                        <span className="px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-600 border">{duration}</span>
                                                        
                                                        {isActive && (
                                                            <span className="flex items-center px-2 py-0.5 rounded text-xs font-bold bg-blue-100 text-blue-700 animate-pulse border border-blue-200">
                                                                <Zap size={10} className="mr-1 fill-blue-700" /> EN CURSO
                                                            </span>
                                                        )}
                                                    </div>
                                                    <h3 className="font-bold text-lg text-gray-800 leading-tight flex items-center">
                                                        {act.title}
                                                        <Info size={14} className="ml-2 text-fjord-400" />
                                                    </h3>
                                                </div>
                                                {isCritical && <AlertTriangle className="text-red-500 animate-pulse" size={20} />}
                                            </div>

                                            {isActive && (
                                                <div className="w-full bg-slate-100 rounded-full h-1.5 mb-3 overflow-hidden">
                                                    <div className="bg-blue-500 h-1.5 rounded-full transition-all duration-1000" style={{ width: `${progressPercent}%` }}></div>
                                                </div>
                                            )}

                                            <div className="mb-3 text-sm text-gray-600 flex items-center flex-wrap gap-1">
                                                <span className="font-medium flex items-center"><MapPin size={14} className="mr-0.5 text-fjord-500"/> {act.locationName}</span>
                                                {dist !== null && (
                                                    <span className="ml-2 text-xs bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded font-bold border border-emerald-200">
                                                        A {formatDistance(dist)}
                                                    </span>
                                                )}
                                            </div>
                                            <p className="text-sm text-gray-600 mb-3 line-clamp-2">{act.description}</p>
                                            
                                            <div className="flex items-center justify-between mt-3 pt-3 border-t border-gray-100" onClick={e => e.stopPropagation()}>
                                                <div className="flex items-center space-x-2 overflow-x-auto hide-scrollbar">
                                                    <button onClick={() => onLocate(act.coords, act.endCoords)} className="flex items-center text-xs font-medium text-fjord-600 bg-fjord-50 px-2 py-1 rounded hover:bg-fjord-100 whitespace-nowrap">
                                                        <MapPin size={14} className="mr-1" /> {act.endCoords ? 'Ruta' : 'Mapa'}
                                                    </button>
                                                    {act.ticketUrl && (
                                                        <a href={act.ticketUrl} target="_blank" rel="noopener noreferrer" className="flex items-center text-xs font-medium text-emerald-600 bg-emerald-50 px-2 py-1 rounded border border-emerald-100 hover:bg-emerald-100 whitespace-nowrap">
                                                            <Ticket size={14} className="mr-1" /> Tickets
                                                        </a>
                                                    )}
                                                    {act.webcamUrl && (
                                                        <a href={act.webcamUrl} target="_blank" rel="noopener noreferrer" className="flex items-center text-xs font-medium text-red-600 bg-red-50 px-2 py-1 rounded border border-red-100 hover:bg-red-100 whitespace-nowrap">
                                                            <Camera size={14} className="mr-1" /> Webcam
                                                        </a>
                                                    )}
                                                </div>
                                                <button onClick={() => onToggleComplete(act.id)} className={`ml-2 px-3 py-1.5 rounded text-xs font-bold uppercase whitespace-nowrap ${act.completed ? 'bg-emerald-100 text-emerald-700' : 'bg-fjord-500 text-white'}`}>
                                                    {act.completed ? 'Listo' : 'Check-in'}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </React.Fragment>
                            );
                        })}
                    </div>
                    <ActivityDetailModal activity={selectedActivity} onClose={() => setSelectedActivity(null)} />
                    <div className="mt-8 text-center text-xs text-slate-400 pb-4">{UPDATE_DATE}</div>
                </div>
            );
        };

        const Budget = ({ itinerary, onToggleComplete }) => {
            const [curr, setCurr] = useState('EUR');
            const paid = useMemo(() => itinerary.filter(a => a.priceEUR > 0), [itinerary]);
            const [rate, setRate] = useState(11.8);
            const [calcAmount, setCalcAmount] = useState('');
            const [calcMode, setCalcMode] = useState('EUR_TO_NOK');
            const [rateLoading, setRateLoading] = useState(false);

            useEffect(() => {
                setRateLoading(true);
                fetch('https://api.exchangerate-api.com/v4/latest/EUR')
                    .then(res => res.json())
                    .then(data => { if(data.rates?.NOK) setRate(data.rates.NOK); setRateLoading(false); })
                    .catch(() => setRateLoading(false));
            }, []);
            
            const calcResult = useMemo(() => {
                const val = parseFloat(calcAmount);
                if(isNaN(val)) return '--';
                if(calcMode === 'EUR_TO_NOK') return (val * rate).toFixed(2) + ' kr';
                return 'â‚¬' + (val / rate).toFixed(2);
            }, [calcAmount, rate, calcMode]);

            const totalEstimated = useMemo(() => paid.reduce((acc, c) => acc + (curr === 'EUR' ? c.priceEUR : c.priceNOK), 0), [paid, curr]);
            const totalSpent = useMemo(() => paid.filter(a => a.completed).reduce((acc, c) => acc + (curr === 'EUR' ? c.priceEUR : c.priceNOK), 0), [paid, curr]);
            const percentage = totalEstimated > 0 ? Math.min(100, Math.round((totalSpent / totalEstimated) * 100)) : 0;

            const typeDistribution = useMemo(() => {
                const types = { transport: 0, food: 0, sightseeing: 0 };
                paid.forEach(a => {
                    const price = curr === 'EUR' ? a.priceEUR : a.priceNOK;
                    if(types[a.type] !== undefined) types[a.type] += price;
                    else types.sightseeing += price; // Fallback
                });
                return types;
            }, [paid, curr]);
            
            const maxVal = Math.max(1, totalEstimated);
            const wTransport = (typeDistribution.transport / maxVal) * 100;
            const wFood = (typeDistribution.food / maxVal) * 100;
            const wSightseeing = (typeDistribution.sightseeing / maxVal) * 100;

            return (
                <div className="pb-24 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-fjord-500 flex items-center"><Wallet className="mr-2"/> Gastos</h2>
                        <div className="flex bg-slate-200 rounded-lg p-1">
                            {['EUR','NOK'].map(c => (
                                <button key={c} onClick={() => setCurr(c)} className={`px-3 py-1 text-sm rounded-md font-bold ${curr===c?'bg-white shadow text-fjord-600':'text-slate-500'}`}>{c}</button>
                            ))}
                        </div>
                    </div>

                    <div className="bg-white p-4 rounded-xl shadow-md border border-slate-100 mb-8">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-gray-700 flex items-center text-sm uppercase">
                                <Calculator size={16} className="mr-2 text-fjord-500"/> Conversor
                            </h3>
                            <span className="text-xs text-slate-400 flex items-center">
                                {rateLoading && <RefreshCw size={10} className="animate-spin mr-1"/>}
                                1 EUR â‰ˆ {rate.toFixed(2)} NOK
                            </span>
                        </div>
                        <div className="flex items-center space-x-2">
                            <div className="relative flex-1">
                                <span className="absolute left-3 top-2.5 text-gray-400 text-sm font-bold">
                                    {calcMode === 'EUR_TO_NOK' ? 'â‚¬' : 'kr'}
                                </span>
                                <input 
                                    type="number" value={calcAmount} onChange={(e) => setCalcAmount(e.target.value)}
                                    placeholder="0" className="w-full pl-8 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fjord-400 font-bold text-gray-800"
                                />
                            </div>
                            <button onClick={() => setCalcMode(prev => prev === 'EUR_TO_NOK' ? 'NOK_TO_EUR' : 'EUR_TO_NOK')} className="p-2 bg-slate-100 rounded-full text-fjord-600 hover:bg-slate-200">
                                <ArrowRightLeft size={18} />
                            </button>
                            <div className="flex-1 text-right bg-fjord-50 border border-fjord-100 py-2 px-3 rounded-lg">
                                <span className="font-bold text-fjord-700 text-lg">{calcResult}</span>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div className="bg-white rounded-xl p-4 shadow border border-slate-100">
                            <p className="text-slate-500 text-xs uppercase font-bold">Gastado</p>
                            <div className="text-2xl font-bold text-emerald-600 mt-1">{curr === 'EUR' ? `â‚¬${totalSpent}` : `${totalSpent} kr`}</div>
                        </div>
                        <div className="bg-slate-50 rounded-xl p-4 shadow-sm border border-slate-100">
                            <p className="text-slate-400 text-xs uppercase font-bold">Presupuesto</p>
                            <div className="text-2xl font-bold text-slate-700 mt-1">{curr === 'EUR' ? `â‚¬${totalEstimated}` : `${totalEstimated} kr`}</div>
                        </div>
                    </div>

                    <div className="w-full bg-slate-200 rounded-full h-4 mb-8 overflow-hidden shadow-inner relative">
                         <div className="absolute top-0 left-0 h-full bg-emerald-500 transition-all duration-500" style={{ width: `${percentage}%` }}></div>
                    </div>

                    <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-4 mb-8">
                        <h3 className="text-sm font-bold text-gray-700 mb-3 uppercase">DistribuciÃ³n de Costes</h3>
                        <div className="w-full h-6 flex rounded-full overflow-hidden mb-2">
                            <div style={{width:`${wTransport}%`}} className="bg-blue-600 h-full"></div>
                            <div style={{width:`${wSightseeing}%`}} className="bg-purple-500 h-full"></div>
                            <div style={{width:`${wFood}%`}} className="bg-orange-500 h-full"></div>
                        </div>
                        <div className="flex text-xs text-gray-500 space-x-4">
                            <div className="flex items-center"><div className="w-2 h-2 rounded-full bg-blue-600 mr-1"></div>Transporte</div>
                            <div className="flex items-center"><div className="w-2 h-2 rounded-full bg-purple-500 mr-1"></div>Actividades</div>
                            <div className="flex items-center"><div className="w-2 h-2 rounded-full bg-orange-500 mr-1"></div>Comida</div>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow-sm border border-slate-200 mb-8">
                        <h3 className="px-4 py-3 border-b font-bold text-gray-700 bg-slate-50">Lista (Toca para marcar)</h3>
                        {paid.map(a => (
                            <div key={a.id} className="flex justify-between items-center p-4 border-b border-slate-50 hover:bg-slate-50 transition-colors cursor-pointer" onClick={() => onToggleComplete(a.id)}>
                                <div className="flex items-center flex-1">
                                    <div className={`mr-3 rounded-full transition-colors ${a.completed ? 'text-emerald-500' : 'text-slate-300'}`}>
                                        {a.completed ? <CheckCircle2 size={24} /> : <Circle size={24} />}
                                    </div>
                                    <div>
                                        <p className={`text-sm font-medium ${a.completed ? 'text-gray-400 line-through' : 'text-gray-800'}`}>{a.title}</p>
                                    </div>
                                </div>
                                <div className={`font-bold ml-4 ${a.completed ? 'text-emerald-600' : 'text-gray-700'}`}>
                                    {curr === 'EUR' ? `â‚¬${a.priceEUR}` : `${a.priceNOK} kr`}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Guide = ({ userLocation }) => {
            const [playing, setPlaying] = useState(null);
            const [weather, setWeather] = useState(null);
            const [hourly, setHourly] = useState([]);

            useEffect(() => {
                fetch('https://api.open-meteo.com/v1/forecast?latitude=60.86&longitude=7.11&current_weather=true&hourly=temperature_2m,weathercode,precipitation_probability&daily=temperature_2m_max,temperature_2m_min,weathercode,sunrise,sunset&timezone=Europe%2FBerlin&forecast_days=5')
                    .then(res => res.json())
                    .then(data => {
                        setWeather(data);
                        if(data.hourly) {
                            const times = data.hourly.time;
                            const temps = data.hourly.temperature_2m;
                            const codes = data.hourly.weathercode;
                            const probs = data.hourly.precipitation_probability;
                            const details = times.map((t, i) => ({ hour: new Date(t).getHours(), temp: temps[i], code: codes[i], prob: probs[i] })).filter(h => h.hour >= 7 && h.hour <= 18);
                            setHourly(details);
                        }
                    })
                    .catch(e => console.error(e));
            }, []);

            const playAudio = (word) => {
                setPlaying(word);
                if ('speechSynthesis' in window) {
                    const u = new SpeechSynthesisUtterance(word);
                    u.lang = 'no-NO';
                    u.rate = 0.8;
                    window.speechSynthesis.speak(u);
                    u.onend = () => setPlaying(null);
                } else { setTimeout(() => setPlaying(null), 1000); }
            };

            const getWeatherIcon = (code, size=24) => {
                if(code <= 3) return <CloudSun size={size} className="text-orange-400" />;
                if(code >= 45 && code <= 48) return <Wind size={size} className="text-slate-400" />;
                if(code >= 71) return <CloudSnow size={size} className="text-blue-300" />;
                if(code >= 51) return <CloudRain size={size} className="text-blue-500" />;
                return <Droplets size={size} className="text-blue-400" />;
            };

            const handleEmergency = () => {
                if (userLocation) shareLocation(userLocation.lat, userLocation.lng);
                else {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => shareLocation(pos.coords.latitude, pos.coords.longitude),
                        () => alert("âš ï¸ No se pudo obtener ubicaciÃ³n GPS.")
                    );
                }
            };

            const shareLocation = (lat, lng) => {
                const url = `https://wa.me/?text=${encodeURIComponent(`ðŸ†˜ SOS! Mi ubicaciÃ³n en FlÃ¥m: https://maps.google.com/?q=${lat},${lng}`)}`;
                window.open(url, '_blank');
            };

            return (
                <div className="pb-24 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto">
                    <h2 className="text-2xl font-bold text-fjord-500 mb-6">GuÃ­a y Consejos</h2>
                    
                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div className="bg-red-600 text-white rounded-xl p-4 shadow-lg flex flex-col items-center text-center border-2 border-red-400 animate-pulse cursor-pointer" onClick={handleEmergency}>
                            <AlertTriangle size={24} className="text-white mb-1" />
                            <h3 className="text-sm font-bold">EMERGENCIA SOS</h3>
                            <span className="text-[10px] mt-1 bg-white/20 px-2 rounded">Enviar UbicaciÃ³n</span>
                        </div>
                        
                        <a href="https://play.google.com/store/apps/details?id=com.msccruises.mscforme" target="_blank" rel="noopener noreferrer" className="bg-blue-900 text-white rounded-xl p-4 shadow-lg flex flex-col items-center text-center border border-blue-700 hover:bg-blue-800 transition-colors">
                            <Smartphone size={24} className="text-white mb-1" />
                            <h3 className="text-sm font-bold">App MSC for Me</h3>
                            <span className="text-[10px] mt-1 bg-white/20 px-2 rounded">Abrir AplicaciÃ³n</span>
                        </a>
                    </div>

                    <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-5 rounded-xl shadow-lg mb-6">
                        <div className="flex justify-between items-center">
                            <div>
                                <h3 className="text-blue-100 text-sm font-bold uppercase mb-1">Clima (Ahora)</h3>
                                {weather ? <div className="text-4xl font-bold">{Math.round(weather.current_weather.temperature)}Â°C</div> : <div className="text-xl">Cargando...</div>}
                            </div>
                            {weather && getWeatherIcon(weather.current_weather.weathercode, 48)}
                        </div>
                    </div>

                    {weather && weather.daily && weather.daily.sunrise && (
                        <div className="bg-white rounded-xl shadow border border-slate-100 p-4 mb-6 flex justify-between items-center">
                            <div className="flex flex-col items-center w-1/3 border-r border-slate-100">
                                <span className="text-xs text-slate-400 uppercase font-bold mb-1">Amanecer</span>
                                <div className="flex items-center text-amber-500">
                                    <Sunrise size={20} className="mr-1" />
                                    <span className="font-bold text-lg">
                                        {new Date(weather.daily.sunrise[0]).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                    </span>
                                </div>
                            </div>
                            <div className="flex flex-col items-center w-1/3 border-r border-slate-100">
                                <span className="text-xs text-slate-400 uppercase font-bold mb-1">Luz Total</span>
                                <span className="font-bold text-slate-600 text-lg">
                                    {(() => {
                                        const s = new Date(weather.daily.sunrise[0]);
                                        const e = new Date(weather.daily.sunset[0]);
                                        const diff = (e - s) / (1000 * 60 * 60);
                                        return Math.floor(diff) + 'h ' + Math.round((diff % 1) * 60) + 'm';
                                    })()}
                                </span>
                            </div>
                            <div className="flex flex-col items-center w-1/3">
                                <span className="text-xs text-slate-400 uppercase font-bold mb-1">Anochecer</span>
                                <div className="flex items-center text-indigo-500">
                                    <Sunset size={20} className="mr-1" />
                                    <span className="font-bold text-lg">
                                        {new Date(weather.daily.sunset[0]).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                    </span>
                                </div>
                            </div>
                        </div>
                    )}

                    {hourly.length > 0 && (
                        <div className="mb-8">
                             <h3 className="font-bold text-gray-700 mb-3 text-sm uppercase flex items-center"><Clock size={16} className="mr-2"/> Escala Hora a Hora</h3>
                             <div className="flex overflow-x-auto pb-4 space-x-3 hide-scrollbar">
                                 {hourly.map(h => (
                                     <div key={h.hour} className="flex flex-col items-center bg-white p-3 rounded-lg border border-slate-100 min-w-[70px] shadow-sm">
                                         <span className="text-xs font-bold text-gray-500 mb-1">{h.hour}:00</span>
                                         <div className="my-1">{getWeatherIcon(h.code, 24)}</div>
                                         <span className="font-bold text-fjord-600">{Math.round(h.temp)}Â°</span>
                                     </div>
                                 ))}
                             </div>
                        </div>
                    )}

                    {weather && weather.daily && (
                        <div className="bg-white rounded-xl shadow border border-slate-100 p-4 mb-8">
                             <h3 className="font-bold text-gray-700 mb-3 text-sm uppercase flex items-center"><CalendarClock size={16} className="mr-2"/> PronÃ³stico 5 DÃ­as</h3>
                             <div className="space-y-3">
                                {weather.daily.time.slice(0, 5).map((day, i) => (
                                    <div key={day} className="flex justify-between items-center text-sm border-b border-gray-50 last:border-0 pb-2">
                                        <span className="font-bold text-gray-600 capitalize w-20">{new Date(day).toLocaleDateString('es-ES', {weekday:'short', day:'numeric'})}</span>
                                        <div className="flex items-center space-x-3">
                                            {getWeatherIcon(weather.daily.weathercode[i])}
                                            <span className="font-medium">
                                                <span className="text-blue-500">{Math.round(weather.daily.temperature_2m_min[i])}Â°</span> / <span className="text-red-500">{Math.round(weather.daily.temperature_2m_max[i])}Â°</span>
                                            </span>
                                        </div>
                                    </div>
                                ))}
                             </div>
                        </div>
                    )}

                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl p-6 text-white shadow-lg mb-8 relative overflow-hidden">
                        <h3 className="text-indigo-100 text-sm font-bold uppercase mb-2 flex items-center"><Languages size={18} className="mr-2"/> Traductor Visual</h3>
                        <a href="https://translate.google.com/?sl=no&tl=es&op=images" target="_blank" rel="noopener noreferrer" className="flex items-center justify-center w-full py-3 bg-white text-indigo-700 rounded-lg font-bold shadow mt-2">
                            <Camera size={20} className="mr-2" /> Activar CÃ¡mara
                        </a>
                    </div>
                    
                    <h3 className="text-lg font-bold text-gray-800 mb-4">PronunciaciÃ³n</h3>
                    <div className="bg-white rounded-lg shadow border border-gray-200">
                        {PRONUNCIATIONS.map((item, i) => (
                            <div key={item.word} className="p-4 flex justify-between items-center border-b last:border-0 border-gray-100">
                                <div>
                                    <div className="flex items-baseline space-x-2">
                                        <span className="font-bold text-lg text-fjord-600">{item.word}</span>
                                        <span className="text-xs text-gray-400 font-mono">{item.phonetic}</span>
                                    </div>
                                    <div className="text-sm text-gray-700">"{item.simplified}"</div>
                                </div>
                                <button onClick={() => playAudio(item.word)} className={`p-3 rounded-full ${playing===item.word?'bg-emerald-100 text-emerald-600':'bg-slate-100 text-slate-500'}`}>
                                    <Volume2 size={20} />
                                </button>
                            </div>
                        ))}
                    </div>
                    <div className="mt-8 text-center text-xs text-slate-400 pb-4">Actualizado el {UPDATE_DATE}</div>
                </div>
            );
        };

        const MapComponent = ({ activities, userLocation, focusedLocation }) => {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const layersRef = useRef([]);

            useEffect(() => {
                if(!mapRef.current || mapInstance.current) return;
                // Use global L
                const map = L.map(mapRef.current).setView([60.8638, 7.1187], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
                mapInstance.current = map;
                
                delete L.Icon.Default.prototype._getIconUrl;
                L.Icon.Default.mergeOptions({
                    iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
                    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                });
                return () => { map.remove(); mapInstance.current = null; };
            }, []);

            useEffect(() => {
                const map = mapInstance.current;
                if(!map) return;
                layersRef.current.forEach(l => l.remove());
                layersRef.current = [];

                const endIcon = L.divIcon({ className: 'end-marker', html: '<div style="background:#3A7D44;width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>', iconSize: [12,12] });

                activities.forEach(act => {
                    layersRef.current.push(L.marker([act.coords.lat, act.coords.lng]).addTo(map).bindPopup(act.title));
                    if(act.endCoords) {
                        layersRef.current.push(L.marker([act.endCoords.lat, act.endCoords.lng], {icon: endIcon}).addTo(map).bindPopup('Fin: ' + act.title));
                        layersRef.current.push(L.polyline([[act.coords.lat, act.coords.lng], [act.endCoords.lat, act.endCoords.lng]], {color: '#2A5B87', weight: 3, dashArray: '5,10'}).addTo(map));
                    }
                });

                if(userLocation) {
                    const uIcon = L.divIcon({ className: 'user', html: '<div style="background:#3b82f6;width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>', iconSize: [16,16] });
                    layersRef.current.push(L.marker([userLocation.lat, userLocation.lng], {icon: uIcon}).addTo(map));
                }
            }, [activities, userLocation]);

            useEffect(() => {
                if(focusedLocation && mapInstance.current) {
                    mapInstance.current.flyTo([focusedLocation.lat, focusedLocation.lng], 18);
                }
            }, [focusedLocation]);

            return <div ref={mapRef} style={{width:'100%', height:'100%'}} />;
        };

        const App = () => {
            const [itinerary, setItinerary] = useState(INITIAL_ITINERARY);
            const [activeTab, setActiveTab] = useState('timeline');
            const [userLocation, setUserLocation] = useState(null);
            const [mapFocus, setMapFocus] = useState(null);
            const [countdown, setCountdown] = useState('');

            useEffect(() => {
                const s = localStorage.getItem('flam_v1');
                if(s) {
                    const p = JSON.parse(s);
                    setItinerary(INITIAL_ITINERARY.map(i => {
                        const saved = p.find(x => x.id === i.id);
                        return saved ? {...i, completed: saved.completed} : i;
                    }));
                }
            }, []);

            const toggle = (id) => {
                const n = itinerary.map(a => a.id === id ? {...a, completed: !a.completed} : a);
                setItinerary(n);
                localStorage.setItem('flam_v1', JSON.stringify(n));
            };

            const locate = (c, ec) => { setMapFocus(c); setActiveTab('map'); };

            useEffect(() => {
                const t = setInterval(() => {
                    const now = new Date();
                    const [h,m] = SHIP_DEPARTURE_TIME.split(':').map(Number);
                    const d = new Date(); d.setHours(h,m,0);
                    const diff = d - now;
                    if(diff <= 0) setCountdown("ZARPANDO");
                    else {
                        const hr = Math.floor(diff/3600000);
                        const mn = Math.floor((diff%3600000)/60000);
                        const sc = Math.floor((diff%60000)/1000);
                        setCountdown(`${hr}h ${mn}m ${sc}s`);
                    }
                }, 1000);
                return () => clearInterval(t);
            }, []);

            useEffect(() => {
                if('geolocation' in navigator) {
                    navigator.geolocation.watchPosition(p => setUserLocation({lat:p.coords.latitude, lng:p.coords.longitude}), null, {enableHighAccuracy:true});
                }
            }, []);

            return (
                <div className="flex flex-col h-screen bg-slate-50 text-slate-900 font-sans overflow-hidden">
                    <header className="bg-fjord-900 text-white p-3 shadow-md z-20 flex justify-between items-center">
                        <div className="flex items-center">
                            <Anchor className="mr-2 text-sunset-500" size={20} />
                            <div><h1 className="font-bold text-sm leading-none">Salida: {SHIP_DEPARTURE_TIME}</h1><p className="text-xs text-fjord-200">Todos a bordo {ONBOARD_TIME}</p></div>
                        </div>
                        <div className="text-xl font-mono font-bold text-sunset-500 tabular-nums">{countdown}</div>
                    </header>

                    <main className="flex-1 overflow-hidden relative">
                        {activeTab === 'timeline' && <div className="h-full overflow-y-auto"><Timeline itinerary={itinerary} onToggleComplete={toggle} onLocate={locate} userLocation={userLocation} /></div>}
                        {activeTab === 'map' && <div className="h-full w-full"><MapComponent activities={itinerary} userLocation={userLocation} focusedLocation={mapFocus} /></div>}
                        {activeTab === 'budget' && <Budget itinerary={itinerary} onToggleComplete={toggle} />}
                        {activeTab === 'guide' && <Guide userLocation={userLocation} />}
                    </main>

                    <nav className="bg-white border-t border-slate-200 shadow-lg z-30 pb-2">
                        <div className="flex justify-around items-center h-16">
                            {[
                                {id:'timeline', icon:CalendarClock, l:'Itinerario'},
                                {id:'map', icon:MapIcon, l:'Mapa'},
                                {id:'budget', icon:Wallet, l:'Gastos'},
                                {id:'guide', icon:BookOpen, l:'GuÃ­a'}
                            ].map(x => (
                                <button key={x.id} onClick={() => setActiveTab(x.id)} className={`flex flex-col items-center w-full justify-center ${activeTab===x.id?'text-fjord-600':'text-slate-400'}`}>
                                    <x.icon size={24} />
                                    <span className="text-[10px] mt-1 font-medium">{x.l}</span>
                                </button>
                            ))}
                        </div>
                    </nav>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js').catch(err => console.log('Error SW:', err));
        });
      }
    </script>
</body>
</html>