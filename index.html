<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>FlÃ¥m Guide 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#2A5B87" />
    <meta name="description" content="GuÃ­a turÃ­stica interactiva para FlÃ¥m 2026" />
    
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              fjord: { 50:'#f0f9ff', 100:'#e0f2fe', 500:'#2A5B87', 600:'#0284c7', 900:'#0c4a6e' },
              mountain: { 500:'#3A7D44' },
              sunset: { 500:'#FFB347' }
            },
            fontFamily: { sans: ['Roboto Condensed', 'sans-serif'] },
            animation: {
                'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            }
          }
        }
      }
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "leaflet": "https://aistudiocdn.com/leaflet@^1.9.4",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "recharts": "https://aistudiocdn.com/recharts@^3.5.1"
  }
}
</script>
    
    <!-- Leaflet JS Global -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { background-color: #f8fafc; overscroll-behavior-y: none; }
        .leaflet-container { width: 100%; height: 100%; z-index: 0; }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 4px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content { animation: fadeIn 0.2s ease-out forwards; }
        
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .active-card { animation: pulse-border 2s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { CalendarClock, Map as MapIcon, Wallet, BookOpen, Anchor, CheckCircle2, Circle, MapPin, AlertTriangle, Clock, ArrowRight, TrendingDown, Info, AlertCircle, ShoppingBag, Volume2, Camera, CloudSun, Wind, Droplets, Umbrella, X, Eye, Lightbulb, ChevronDown, Ticket, Zap, Calculator, ArrowRightLeft, RefreshCw, Languages, Utensils, Instagram, CloudRain, CloudSnow, Sun, Smartphone, Sunrise, Sunset, Moon, Play } from 'lucide-react';

        // --- CONSTANTS ---
        const SHIP_DEPARTURE_TIME = "18:00";
        const ONBOARD_TIME = "17:45";
        const UPDATE_DATE = "04 de diciembre de 2025";
        
        const COORDS = {
            FLAM_DOCK: { lat: 60.8638, lng: 7.1187 },
            FLAM_STATION: { lat: 60.8632, lng: 7.1145 },
            MYRDAL: { lat: 60.7353, lng: 7.1226 },
            AEGIR_PUB: { lat: 60.8638, lng: 7.1172 },
            GUDVANGEN: { lat: 60.8812, lng: 6.8413 },
            STEGASTEIN_VIEWPOINT: { lat: 60.9085, lng: 7.2123 },
            VISITOR_CENTER: { lat: 60.8622, lng: 7.1115 }
        };

        const INITIAL_ITINERARY = [
            {
                id: '1', title: 'Llegada a Puerto', startTime: '07:00', endTime: '07:15',
                locationName: 'Fiordo de Aurlandsfjord', coords: COORDS.FLAM_DOCK,
                description: 'El MSC Euribia atraca en el puerto de FlÃ¥m.',
                fullDescription: 'Disfruta de las vistas de la llegada navegando por el fiordo antes de atracar. El barco inicia maniobras de atraque.',
                tips: 'Sube a cubierta para ver la aproximaciÃ³n al fiordo. Es espectacular.',
                keyDetails: 'Hora de llegada oficial.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false
            },
            {
                id: '2', title: 'Desayuno Buffet "Marketplace"', startTime: '07:15', endTime: '07:45',
                locationName: 'MSC Euribia', coords: COORDS.FLAM_DOCK,
                description: 'Carga energÃ­a antes de bajar.',
                fullDescription: 'Desayuno completo en el buffet Marketplace del barco antes de iniciar la excursiÃ³n.',
                tips: 'Come bien, el almuerzo en el pub es hasta las 10:40. Lleva agua.',
                keyDetails: 'Buffet abierto.',
                priceNOK: 0, priceEUR: 0, type: 'food', completed: false
            },
            {
                id: '3', title: 'Desembarque y OrientaciÃ³n', startTime: '08:00', endTime: '08:15',
                locationName: 'Muelle de Cruceros', coords: COORDS.FLAM_DOCK,
                description: 'Bajada del barco y camino a la estaciÃ³n.',
                fullDescription: 'FlÃ¥m estarÃ¡ fresco. Baja del barco y dirÃ­gete directamente a la estaciÃ³n de tren (a 200m).',
                tips: 'Aprovecha para sacar fotos del barco y el fiordo en la luz de la maÃ±ana. Es el mejor momento para fotos sin multitudes.',
                keyDetails: 'Webcam en vivo disponible.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false, notes: 'Webcam disponible',
                webcamUrl: 'https://www.norwaysbest.com/es/flam/webcam-de-flam',
                instagramUrl: 'https://www.instagram.com/explore/tags/flam/'
            },
            {
                id: '4', title: 'El Tren (FlÃ¥msbana)', startTime: '08:20', endTime: '10:28',
                locationName: 'EstaciÃ³n de FlÃ¥m', endLocationName: 'EstaciÃ³n Myrdal',
                coords: COORDS.FLAM_STATION, endCoords: COORDS.MYRDAL,
                description: 'Considerado uno de los viajes en tren mÃ¡s bonitos del mundo.',
                fullDescription: 'Considerado uno de los viajes en tren mÃ¡s bonitos del mundo. SubirÃ¡s desde el nivel del mar hasta 867 metros. VerÃ¡s la cascada Kjosfossen (donde el tren para fotos) y valles profundos.',
                tips: 'Â¡Toma el primer tren! EstarÃ¡s en Myrdal antes de que lleguen otros cruceros.\n\nâ­ ASIENTOS: LADO IZQUIERDO SUBIDA â€“ LADO DERECHO BAJADA.',
                keyDetails: 'Ida y vuelta (~2 horas).',
                priceNOK: 800, priceEUR: 70, type: 'transport', completed: false, notes: 'Parada en cascada Kjosfossen',
                ticketUrl: 'https://www.norwaysbest.com/es/actividades/el-tren-de-flam',
                instagramUrl: 'https://www.instagram.com/explore/tags/flamsbana/'
            },
            {
                id: '5', title: 'Bebida en Ã†gir BrewPub', startTime: '10:40', endTime: '11:40',
                locationName: 'Ã†gir BrewPub', coords: COORDS.AEGIR_PUB,
                description: 'Edificio vikingo con chimenea de 9 metros.',
                fullDescription: 'Un edificio inspirado en la mitologÃ­a nÃ³rdica, con arquitectura de madera flotante, cabezas de dragÃ³n y una impresionante chimenea central de 9 metros de altura.',
                tips: 'Â¡Tiempo para el festÃ­n! Disfruta de la chimenea y el ambiente vikingo antes del barco.',
                keyDetails: 'Bebida en el pub vikingo (segÃºn presupuesto).',
                priceNOK: 80, priceEUR: 8.50, type: 'food', completed: false,
                ticketUrl: 'https://www.google.com/search?q=https://www.flamsbrygga.no/en/aegir-brewpub/&authuser=1',
                instagramUrl: 'https://www.instagram.com/explore/tags/aegirbrewpub/'
            },
            {
                id: '6', title: 'Fjord Cruise + Bus', startTime: '12:00', endTime: '14:30',
                locationName: 'Puerto FlÃ¥m', endLocationName: 'Gudvangen',
                coords: COORDS.FLAM_DOCK, endCoords: COORDS.GUDVANGEN,
                description: 'NavegarÃ¡s por el NÃ¦rÃ¸yfjord (UNESCO).',
                fullDescription: 'NavegarÃ¡s por el NÃ¦rÃ¸yfjord (Patrimonio UNESCO). Es la parte mÃ¡s estrecha y espectacular del fiordo, con cascadas y granjas aisladas en las laderas.',
                tips: 'LogÃ­stica: Toma la salida del barco elÃ©ctrico a las 12:00. Navegas FlÃ¥m â†’ Gudvangen, y tomas el bus de vuelta (shuttle incluido en el ticket) a FlÃ¥m.',
                keyDetails: 'DuraciÃ³n total 2.5 horas.',
                priceNOK: 950, priceEUR: 85, type: 'sightseeing', completed: false,
                ticketUrl: 'https://www.norwaysbest.com/es/flam/actividades/crucero-por-el-fiordo-naeroyfjord',
                instagramUrl: 'https://www.instagram.com/explore/tags/nÃ¦rÃ¸yfjord/'
            },
            {
                id: '7', title: 'Mirador Stegastein', startTime: '15:00', endTime: '16:30',
                locationName: 'Parada Bus FlÃ¥m', endLocationName: 'Mirador Stegastein',
                coords: COORDS.FLAM_STATION, endCoords: COORDS.STEGASTEIN_VIEWPOINT,
                description: 'Plataforma a 650m sobre el fiordo.',
                fullDescription: 'Una plataforma de acero y madera que sobresale 30 metros de la montaÃ±a y cuelga a 650 metros sobre el fiordo con un panel frontal de cristal Ãºnico.',
                tips: 'Toma el bus a las 15:00. VolverÃ¡s con las espectaculares luces del atardecer primaveral sobre el fiordo.',
                keyDetails: 'Tour en bus ida y vuelta.',
                priceNOK: 450, priceEUR: 40, type: 'sightseeing', completed: false,
                ticketUrl: 'https://www.norwaysbest.com/es/flam/actividades/mirador-stegastein',
                instagramUrl: 'https://www.instagram.com/explore/tags/stegastein/'
            },
            {
                id: '8', title: 'Compras y Relax', startTime: '16:30', endTime: '17:30',
                locationName: 'Centro de Visitantes', coords: COORDS.VISITOR_CENTER,
                description: 'Tiendas de souvenirs y artesanÃ­as.',
                fullDescription: 'Tiendas de souvenirs con suÃ©teres de lana noruega autÃ©ntica y artesanÃ­as locales.',
                tips: 'Â¡Nuevo! Una hora completa para el paseo sin prisas gracias a la hora extra. Ãšltimo cafÃ© o souvenir.',
                keyDetails: 'Relajado, sin prisa.',
                priceNOK: 0, priceEUR: 0, type: 'shopping', completed: false
            },
            {
                id: '9', title: 'Caminata Final al Barco', startTime: '17:30', endTime: '17:45',
                locationName: 'Centro -> Muelle', coords: COORDS.FLAM_DOCK,
                description: 'Traslado tranquilo al muelle.',
                fullDescription: 'Comienza a moverte tranquilamente hacia el muelle para el embarque.',
                tips: 'Advertencia: No apures el tiempo. Es el momento de volver.',
                keyDetails: '15 min de caminata.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false
            },
            {
                id: '10', title: 'Â¡A BORDO! (LÃ­mite 17:45)', startTime: '17:45', endTime: '18:00',
                locationName: 'Muelle', coords: COORDS.FLAM_DOCK,
                description: 'Pasarela se retira 17:45. Zarpe 18:00.',
                fullDescription: 'Regreso obligatorio al barco. A las 17:45 se retira la pasarela. A las 18:00 el barco inicia la maniobra de salida.',
                tips: 'Â¡ADVERTENCIA! No llegues tarde. Hora lÃ­mite absoluta para embarcar: 17:45.',
                keyDetails: 'CRÃTICO: SALIDA DEL BARCO 18:00.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false, notes: 'CRITICAL'
            }
        ];

        const PRONUNCIATIONS = [
            { word: 'FlÃ¥m', phonetic: '/floËm/', simplified: 'FLOUM', meaning: 'Llanura pequeÃ±a' },
            { word: 'FlÃ¥msbana', phonetic: '/flÉ”msbÉ‘ËnÉ‘/', simplified: 'FLOM-baana', meaning: 'Tren de FlÃ¥m' },
            { word: 'Myrdal', phonetic: '/myËrdÉ‘l/', simplified: 'MÃœR-dal', meaning: 'Valle pantanoso' },
            { word: 'Ã†gir', phonetic: '/ËˆÉ›ËjiÉ¾/', simplified: 'Ã‰G-uir', meaning: 'Gigante del mar' },
            { word: 'NÃ¦rÃ¸yfjord', phonetic: '/ËˆnÉ›ËrÅ“ÉªfjÉ”r/', simplified: 'NEHR-oy-fiuord', meaning: 'Fiordo estrecho' },
            { word: 'Stegastein', phonetic: '/ËˆstÉ›gÉ‘stÉ‘Éªn/', simplified: 'STÃ‰-ga-stain', meaning: 'Piedra del sendero' },
            { word: 'Gudvangen', phonetic: '/ËˆgÊ‰dÊ‹É‘Å‹É™n/', simplified: 'GÃœD-vang-en', meaning: 'Campo de los dioses' },
            { word: 'Takk', phonetic: '/tak/', simplified: 'TAK', meaning: 'Gracias' },
        ];

        // --- UTILS ---
        const calculateDistance = (c1, c2) => {
            if(!c1 || !c2) return 0;
            const R = 6371e3; 
            const Ï†1 = c1.lat * Math.PI/180;
            const Ï†2 = c2.lat * Math.PI/180;
            const Î”Ï† = (c2.lat-c1.lat) * Math.PI/180;
            const Î”Î» = (c2.lng-c1.lng) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2)*Math.sin(Î”Ï†/2) + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)*Math.sin(Î”Î»/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        };

        const formatDistance = (meters) => {
            if (meters < 1000) return `${Math.round(meters)} m`;
            return `${(meters / 1000).toFixed(1)} km`;
        };

        const calculateDuration = (start, end) => {
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            let diff = (eh*60+em) - (sh*60+sm);
            if(diff < 0) diff += 24*60;
            const h = Math.floor(diff/60);
            const m = diff%60;
            return h > 0 && m > 0 ? `${h}h ${m}m` : (h > 0 ? `${h}h` : `${m} min`);
        };

        const calculateTimeGap = (endPrevious, startNext) => {
            const [eh, em] = endPrevious.split(':').map(Number);
            const [sh, sm] = startNext.split(':').map(Number);
            let diff = (sh*60+sm) - (eh*60+em);
            if (diff <= 0) return null;
            return diff < 60 ? `${diff} min` : `${Math.floor(diff/60)}h ${diff%60}m`;
        };

        const formatTimeRemaining = (targetTimeStr) => {
            const now = new Date();
            const [h, m] = targetTimeStr.split(':').map(Number);
            const target = new Date(now); target.setHours(h, m, 0, 0);
            if(target < now) return "Terminado";
            const diffMs = target - now;
            const dh = Math.floor(diffMs/(1000*60*60));
            const dm = Math.floor((diffMs%(1000*60*60))/(1000*60));
            return dh > 0 ? `${dh}h ${dm}m` : `${dm}m`;
        };

        // --- COMPONENTS ---

        const ActivityDetailModal = ({ activity, onClose }) => {
            if (!activity) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] modal-content">
                        {/* Header */}
                        <div className="bg-fjord-500 p-4 text-white relative">
                            <h3 className="text-xl font-bold pr-8">{activity.title}</h3>
                            <div className="flex items-center text-fjord-100 text-sm mt-1">
                                <Clock size={14} className="mr-1" />
                                {activity.startTime} - {activity.endTime}
                            </div>
                            <button onClick={onClose} className="absolute top-4 right-4 text-white/80 hover:text-white bg-white/10 rounded-full p-1">
                                <X size={20} />
                            </button>
                        </div>
                        
                        {/* Content */}
                        <div className="p-5 overflow-y-auto">
                            <div className="mb-4">
                                <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">DescripciÃ³n</h4>
                                <p className="text-gray-700 leading-relaxed">{activity.fullDescription || activity.description}</p>
                            </div>
                            
                            <div className="mb-4 bg-orange-50 p-3 rounded-lg border border-orange-100">
                                <h4 className="text-xs font-bold text-orange-600 uppercase tracking-wider mb-1 flex items-center">
                                    <Lightbulb size={12} className="mr-1" /> Consejo Pro
                                </h4>
                                <p className="text-sm text-orange-800 italic">{activity.tips}</p>
                            </div>
                            
                            {/* Instagram Button */}
                            {activity.instagramUrl && (
                                <a href={activity.instagramUrl} target="_blank" rel="noopener noreferrer" 
                                   className="flex items-center justify-center w-full mb-4 p-3 rounded-xl bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 text-white font-bold shadow-md hover:shadow-lg transition-all active:scale-95">
                                    <Instagram className="mr-2" size={20} />
                                    Ver Fotos en Instagram
                                </a>
                            )}
                            
                            {/* Actions */}
                            <div className="space-y-3 pt-2">
                                {activity.webcamUrl && (
                                    <a href={activity.webcamUrl} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center w-full p-3 bg-slate-100 text-slate-700 rounded-xl font-medium hover:bg-slate-200 transition-colors">
                                        <Camera className="mr-2" size={18} />
                                        Ver Webcam en Vivo
                                    </a>
                                )}
                                
                                {activity.ticketUrl && (
                                    <a href={activity.ticketUrl} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center w-full p-3 bg-emerald-600 text-white rounded-xl font-bold shadow-md hover:bg-emerald-700 transition-colors">
                                        <Ticket className="mr-2" size={18} />
                                        Comprar Tickets Online
                                    </a>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Timeline = ({ itinerary, onToggleComplete, onLocate, userLocation, onSelectActivity }) => {
            const now = new Date();
            const currentTimeMinutes = now.getHours() * 60 + now.getMinutes();
            
            return (
                <div className="pb-24 px-4 pt-4 max-w-lg mx-auto">
                    <h2 className="text-2xl font-bold text-fjord-500 mb-2">Itinerario Lujo Matutino</h2>
                    <p className="text-xs text-slate-500 mb-6 flex items-center">
                        <Info size={12} className="mr-1"/> Toca una tarjeta para ver detalles
                    </p>
                    
                    <div className="relative border-l-2 border-slate-200 ml-3">
                        {itinerary.map((act, index) => {
                            const [sh, sm] = act.startTime.split(':').map(Number);
                            const [eh, em] = act.endTime.split(':').map(Number);
                            const startMinutes = sh * 60 + sm;
                            const endMinutes = eh * 60 + em;
                            
                            // Status Checks
                            const isActive = currentTimeMinutes >= startMinutes && currentTimeMinutes < endMinutes;
                            const isPast = currentTimeMinutes >= endMinutes;
                            const isCritical = act.notes === 'CRITICAL';
                            const duration = calculateDuration(act.startTime, act.endTime);
                            
                            // Calculate Gap to next activity
                            let gapElement = null;
                            if (index < itinerary.length - 1) {
                                const nextAct = itinerary[index + 1];
                                const gap = calculateTimeGap(act.endTime, nextAct.startTime);
                                if (gap) {
                                    // Check if NOW is in the gap
                                    const [nsh, nsm] = nextAct.startTime.split(':').map(Number);
                                    const nextStartMinutes = nsh * 60 + nsm;
                                    const isGapNow = currentTimeMinutes >= endMinutes && currentTimeMinutes < nextStartMinutes;

                                    gapElement = (
                                        <div className="relative pl-6 py-4">
                                            {isGapNow && (
                                                <div className="absolute left-[-6px] top-1/2 -translate-y-1/2 w-full flex items-center z-10">
                                                    <div className="w-3 h-3 bg-red-500 rounded-full border-2 border-white shadow"></div>
                                                    <div className="h-[2px] bg-red-500 w-full opacity-50"></div>
                                                    <span className="absolute right-0 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded font-bold">
                                                        AHORA {now.getHours()}:{String(now.getMinutes()).padStart(2,'0')}
                                                    </span>
                                                </div>
                                            )}
                                            <div className="flex items-center justify-center">
                                                <span className="bg-slate-100 text-slate-500 text-xs px-2 py-1 rounded-full border border-slate-200 flex items-center">
                                                    <ChevronDown size={12} className="mr-1" />
                                                    {gap} traslado / libre
                                                </span>
                                            </div>
                                        </div>
                                    );
                                }
                            }

                            // Calculate Progress if Active
                            let progress = 0;
                            if (isActive) {
                                const totalDuration = endMinutes - startMinutes;
                                const elapsed = currentTimeMinutes - startMinutes;
                                progress = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
                            }

                            return (
                                <React.Fragment key={act.id}>
                                    <div className="pl-6 relative group">
                                        {/* Dot */}
                                        <div 
                                            className={`absolute -left-[9px] top-4 w-5 h-5 rounded-full border-4 cursor-pointer transition-all bg-white z-10 ${
                                                act.completed ? 'border-emerald-500' : isActive ? 'border-blue-500 scale-125' : 'border-slate-300'
                                            }`}
                                            onClick={(e) => { e.stopPropagation(); onToggleComplete(act.id); }}
                                        >
                                            {act.completed && <div className="w-full h-full bg-emerald-500 rounded-full scale-50" />}
                                        </div>

                                        {/* Card */}
                                        <div 
                                            onClick={() => onSelectActivity(act)}
                                            className={`
                                                relative p-4 rounded-xl border shadow-sm transition-all cursor-pointer overflow-hidden
                                                ${isActive ? 'bg-white border-blue-400 ring-2 ring-blue-100 shadow-blue-100' : 'bg-white border-slate-200 hover:border-blue-300'}
                                                ${act.completed ? 'opacity-70 bg-slate-50' : ''}
                                                ${isCritical ? 'bg-red-50 border-red-200' : ''}
                                            `}
                                        >
                                            {isActive && (
                                                <div className="absolute top-0 left-0 w-full h-1 bg-blue-100">
                                                    <div className="h-full bg-blue-500 transition-all duration-1000" style={{ width: `${progress}%` }}></div>
                                                </div>
                                            )}

                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <div className="flex items-center space-x-2 mb-1">
                                                        <span className={`text-xs font-bold px-1.5 py-0.5 rounded ${isActive ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600'}`}>
                                                            {act.startTime}
                                                        </span>
                                                        <span className="text-xs text-slate-400 font-medium">{duration}</span>
                                                        {isActive && <span className="text-[10px] font-bold text-blue-600 animate-pulse">âš¡ EN CURSO</span>}
                                                    </div>
                                                    <h3 className={`font-bold text-lg leading-tight ${isCritical ? 'text-red-700' : 'text-slate-800'}`}>
                                                        {act.title}
                                                    </h3>
                                                </div>
                                                {act.ticketUrl && <Ticket size={18} className="text-emerald-500" />}
                                                {isCritical && <AlertTriangle size={20} className="text-red-500" />}
                                            </div>

                                            <p className="text-sm text-slate-600 line-clamp-2 mb-2">{act.description}</p>

                                            <div className="flex items-center justify-between mt-2 pt-2 border-t border-slate-100">
                                                <div className="flex items-center text-xs text-slate-500">
                                                    <MapPin size={12} className="mr-1" />
                                                    {act.locationName}
                                                    {userLocation && (
                                                        <span className="ml-2 text-blue-600 font-medium">
                                                            ({formatDistance(calculateDistance(userLocation, act.coords))})
                                                        </span>
                                                    )}
                                                </div>
                                                
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); onLocate(act.coords, act.endCoords); }}
                                                    className="p-1.5 hover:bg-slate-100 rounded-full text-fjord-600"
                                                >
                                                    <MapIcon size={16} />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {gapElement}
                                </React.Fragment>
                            );
                        })}
                        
                        {/* Copyright Footer */}
                        <div className="text-center py-8 text-slate-400 text-xs mt-4">
                            <p className="font-medium">FlÃ¥m Guide 2026</p>
                            <p>Actualizado el {UPDATE_DATE}</p>
                            <p className="mt-1">Â© 2025 - 2026 Gonzalo Arenas de la Hoz</p>
                        </div>
                    </div>
                </div>
            );
        };

        const Budget = ({ itinerary }) => {
            const [currency, setCurrency] = useState('EUR'); // EUR or NOK
            const [rate, setRate] = useState(11.8); // Default fallback rate
            const [calcAmount, setCalcAmount] = useState('');
            const [calcMode, setCalcMode] = useState('EUR_TO_NOK');
            
            // Toggle completed items for budget
            const [paidItems, setPaidItems] = useState(
                itinerary.filter(a => a.priceEUR > 0).map(a => a.id) // Default all checked
            );

            // Fetch Live Rate
            useEffect(() => {
                fetch('https://api.exchangerate-api.com/v4/latest/EUR')
                    .then(res => res.json())
                    .then(data => {
                        if(data && data.rates && data.rates.NOK) {
                            setRate(data.rates.NOK);
                        }
                    })
                    .catch(err => console.log('Using offline rate'));
            }, []);

            const togglePaid = (id) => {
                if (paidItems.includes(id)) {
                    setPaidItems(paidItems.filter(i => i !== id));
                } else {
                    setPaidItems([...paidItems, id]);
                }
            };

            const stats = useMemo(() => {
                const totalEUR = itinerary.reduce((sum, item) => sum + item.priceEUR, 0);
                const currentEUR = itinerary
                    .filter(item => paidItems.includes(item.id))
                    .reduce((sum, item) => sum + item.priceEUR, 0);
                
                return {
                    total: currency === 'EUR' ? totalEUR : totalEUR * rate,
                    current: currency === 'EUR' ? currentEUR : currentEUR * rate,
                    pending: currency === 'EUR' ? (totalEUR - currentEUR) : (totalEUR - currentEUR) * rate
                };
            }, [itinerary, paidItems, currency, rate]);

            // Conversion logic
            const convertedValue = useMemo(() => {
                const val = parseFloat(calcAmount);
                if (isNaN(val)) return '---';
                if (calcMode === 'EUR_TO_NOK') return (val * rate).toFixed(2) + ' kr';
                return (val / rate).toFixed(2) + ' â‚¬';
            }, [calcAmount, calcMode, rate]);

            return (
                <div className="pb-24 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto">
                    {/* Header & Currency Toggle */}
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-fjord-500 flex items-center">
                            <Wallet className="mr-2" /> Gastos
                        </h2>
                        <div className="flex bg-slate-200 rounded-lg p-1">
                            <button onClick={() => setCurrency('EUR')} className={`px-3 py-1 text-sm rounded-md font-bold transition-all ${currency === 'EUR' ? 'bg-white shadow text-fjord-600' : 'text-slate-500'}`}>EUR</button>
                            <button onClick={() => setCurrency('NOK')} className={`px-3 py-1 text-sm rounded-md font-bold transition-all ${currency === 'NOK' ? 'bg-white shadow text-fjord-600' : 'text-slate-500'}`}>NOK</button>
                        </div>
                    </div>

                    {/* Converter Tool */}
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="text-xs font-bold text-slate-400 uppercase flex items-center">
                                <Calculator size={12} className="mr-1"/> Conversor (1â‚¬ â‰ˆ {rate.toFixed(2)} kr)
                            </h3>
                            <button onClick={() => setCalcMode(prev => prev === 'EUR_TO_NOK' ? 'NOK_TO_EUR' : 'EUR_TO_NOK')} className="p-1 bg-slate-100 rounded hover:bg-slate-200">
                                <ArrowRightLeft size={14} className="text-slate-600" />
                            </button>
                        </div>
                        <div className="flex items-center space-x-2">
                            <div className="relative flex-1">
                                <input 
                                    type="number" 
                                    value={calcAmount}
                                    onChange={(e) => setCalcAmount(e.target.value)}
                                    placeholder="Cantidad"
                                    className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg font-mono text-lg outline-none focus:border-fjord-500"
                                />
                                <span className="absolute right-3 top-1/2 -translate-y-1/2 text-sm text-slate-400 font-bold">
                                    {calcMode === 'EUR_TO_NOK' ? 'â‚¬' : 'kr'}
                                </span>
                            </div>
                            <div className="text-slate-400"><ArrowRight size={16}/></div>
                            <div className="flex-1 p-2 bg-fjord-50 border border-fjord-100 rounded-lg text-lg font-bold text-fjord-700 text-center">
                                {convertedValue}
                            </div>
                        </div>
                    </div>

                    {/* Big Stats Card */}
                    <div className="bg-gradient-to-r from-fjord-600 to-fjord-800 rounded-2xl p-6 text-white shadow-xl mb-6 relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-10"><Wallet size={100}/></div>
                        <div className="relative z-10">
                            <p className="text-fjord-200 text-xs font-bold uppercase tracking-wider mb-1">Gasto Realizado</p>
                            <div className="text-4xl font-bold mb-2">
                                {currency === 'EUR' ? 'â‚¬' : ''}{stats.current.toFixed(0)}{currency === 'NOK' ? ' kr' : ''}
                            </div>
                            <div className="w-full bg-black/20 h-2 rounded-full mb-2">
                                <div className="bg-emerald-400 h-full rounded-full transition-all duration-500" style={{ width: `${Math.min(100, (stats.current / stats.total) * 100)}%` }}></div>
                            </div>
                            <div className="flex justify-between text-xs text-fjord-100 font-medium">
                                <span>Total: {stats.total.toFixed(0)}</span>
                                <span>Restante: {stats.pending.toFixed(0)}</span>
                            </div>
                        </div>
                    </div>

                    {/* Interactive List */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        {itinerary.filter(i => i.priceEUR > 0).map((item) => (
                            <div 
                                key={item.id} 
                                onClick={() => togglePaid(item.id)}
                                className="flex items-center justify-between p-4 border-b border-slate-50 last:border-0 hover:bg-slate-50 cursor-pointer transition-colors"
                            >
                                <div className="flex items-center">
                                    <div className={`w-5 h-5 rounded border mr-3 flex items-center justify-center transition-colors ${paidItems.includes(item.id) ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300 bg-white'}`}>
                                        {paidItems.includes(item.id) && <CheckCircle2 size={14} className="text-white" />}
                                    </div>
                                    <div>
                                        <p className={`font-medium ${paidItems.includes(item.id) ? 'text-slate-400 line-through' : 'text-slate-800'}`}>{item.title}</p>
                                        <p className="text-xs text-slate-400 capitalize">{item.type}</p>
                                    </div>
                                </div>
                                <div className={`font-bold font-mono ${paidItems.includes(item.id) ? 'text-slate-400' : 'text-fjord-600'}`}>
                                    {currency === 'EUR' ? `â‚¬${item.priceEUR}` : `${item.priceNOK} kr`}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Guide = ({ userLocation }) => {
            const [playing, setPlaying] = useState(null);
            const [weather, setWeather] = useState(null);
            const [forecast, setForecast] = useState([]);
            const [hourlyForecast, setHourlyForecast] = useState([]);
            const [astronomy, setAstronomy] = useState(null);
            const [showCamera, setShowCamera] = useState(false);

            // Fetch Weather & Solar Data
            useEffect(() => {
                // Weather
                fetch('https://api.open-meteo.com/v1/forecast?latitude=60.86&longitude=7.11&current=temperature_2m,weather_code,is_day&hourly=temperature_2m,precipitation_probability,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Europe%2FBerlin&forecast_days=5')
                    .then(res => res.json())
                    .then(data => {
                        setWeather(data);
                        
                        // Process Hourly (07:00 - 18:00 for today)
                        if (data.hourly) {
                            const hourly = [];
                            // Loop through first 24 indices (Today)
                            for(let i = 0; i < 24; i++) {
                                const timeStr = data.hourly.time[i]; // "2025-12-04T07:00"
                                const hourStr = timeStr.split('T')[1].split(':')[0];
                                const hour = parseInt(hourStr, 10);
                                
                                if (hour >= 7 && hour <= 18) {
                                    hourly.push({
                                        time: `${hourStr}:00`,
                                        temp: Math.round(data.hourly.temperature_2m[i]),
                                        precip: data.hourly.precipitation_probability[i],
                                        code: data.hourly.weather_code[i]
                                    });
                                }
                            }
                            setHourlyForecast(hourly);
                        }

                        // Process 5-day forecast
                        if(data.daily) {
                            const days = data.daily.time.map((t, i) => ({
                                date: t,
                                max: data.daily.temperature_2m_max[i],
                                min: data.daily.temperature_2m_min[i],
                                code: data.daily.weather_code[i]
                            }));
                            setForecast(days);
                        }
                    })
                    .catch(e => console.log('Weather offline'));

                // Solar/Astronomy (Using sunrise-sunset.org or similar, or Open-Meteo daily)
                fetch('https://api.open-meteo.com/v1/forecast?latitude=60.86&longitude=7.11&daily=sunrise,sunset,daylight_duration&timezone=Europe%2FBerlin&forecast_days=1')
                    .then(res => res.json())
                    .then(data => {
                        if (data.daily) {
                            setAstronomy({
                                sunrise: data.daily.sunrise[0], // ISO String
                                sunset: data.daily.sunset[0],   // ISO String
                                duration: (data.daily.daylight_duration[0] / 3600).toFixed(1)
                            });
                        }
                    })
                    .catch(e => console.log("Astronomy offline"));
            }, []);

            const playAudio = (text) => {
                if ('speechSynthesis' in window) {
                    setPlaying(text);
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'no-NO'; // Norwegian
                    utterance.rate = 0.9;
                    utterance.onend = () => setPlaying(null);
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert("Tu navegador no soporta audio.");
                }
            };

            const getWeatherIcon = (code) => {
                if (code <= 3) return <Sun className="text-yellow-500" />;
                if (code <= 60) return <CloudRain className="text-blue-400" />;
                return <CloudSnow className="text-gray-400" />;
            };

            const handleSOS = () => {
                if (!userLocation) {
                    alert("Necesitamos tu ubicaciÃ³n primero. AsegÃºrate de tener el GPS activo.");
                    return;
                }
                const text = `ðŸ†˜ SOS! Necesito ayuda. Mi ubicaciÃ³n actual en FlÃ¥m es: https://maps.google.com/?q=${userLocation.lat},${userLocation.lng}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            };

            const openTranslator = () => {
                // Google Translate Camera Mode
                window.open('https://translate.google.com/?sl=no&tl=es&op=images', '_blank');
            };
            
            const openMSCApp = () => {
                // Try to open Play Store page which will offer "Open" if installed
                window.open('https://play.google.com/store/apps/details?id=com.msccruises.mscforme', '_blank');
            };

            // Solar Chart Helper
            const renderSolarChart = () => {
                if (!astronomy) return <div className="text-xs text-slate-400">Cargando datos solares...</div>;

                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                const totalMinutes = 24 * 60;
                const nowPercent = (currentMinutes / totalMinutes) * 100;

                const sunriseDate = new Date(astronomy.sunrise);
                const sunsetDate = new Date(astronomy.sunset);
                
                const sunriseMins = sunriseDate.getHours() * 60 + sunriseDate.getMinutes();
                const sunsetMins = sunsetDate.getHours() * 60 + sunsetDate.getMinutes();
                
                const sunrisePercent = (sunriseMins / totalMinutes) * 100;
                const sunsetPercent = (sunsetMins / totalMinutes) * 100;

                const sunriseStr = `${String(sunriseDate.getHours()).padStart(2,'0')}:${String(sunriseDate.getMinutes()).padStart(2,'0')}`;
                const sunsetStr = `${String(sunsetDate.getHours()).padStart(2,'0')}:${String(sunsetDate.getMinutes()).padStart(2,'0')}`;

                return (
                    <div className="mt-4 bg-slate-900 rounded-xl p-4 text-white relative overflow-hidden shadow-inner">
                        <div className="flex justify-between text-xs text-slate-400 mb-6 font-mono">
                            <span>00:00</span>
                            <span>12:00</span>
                            <span>23:59</span>
                        </div>
                        
                        {/* The Bar Container */}
                        <div className="relative h-12 w-full rounded-full bg-slate-800 overflow-hidden border border-slate-700">
                            {/* Day Segment (Blue) */}
                            <div 
                                className="absolute top-0 bottom-0 bg-sky-400"
                                style={{ 
                                    left: `${sunrisePercent}%`, 
                                    width: `${sunsetPercent - sunrisePercent}%` 
                                }}
                            ></div>

                            {/* Sunrise Gradient Overlay */}
                            <div 
                                className="absolute top-0 bottom-0 w-8 -ml-4 bg-gradient-to-r from-slate-800 via-orange-400 to-sky-400 opacity-90"
                                style={{ left: `${sunrisePercent}%` }}
                            ></div>

                            {/* Sunset Gradient Overlay */}
                            <div 
                                className="absolute top-0 bottom-0 w-8 -ml-4 bg-gradient-to-r from-sky-400 via-orange-500 to-slate-800 opacity-90"
                                style={{ left: `${sunsetPercent}%` }}
                            ></div>
                            
                            {/* NOW Indicator */}
                            <div 
                                className="absolute top-0 bottom-0 w-0.5 bg-red-500 z-10 shadow-[0_0_10px_rgba(239,68,68,0.8)]"
                                style={{ left: `${nowPercent}%` }}
                            >
                                <div className="absolute -top-1 -left-[3px] w-2 h-2 bg-red-500 rounded-full"></div>
                                <div className="absolute top-1/2 -left-6 bg-red-600 text-white text-[9px] font-bold px-1 rounded transform -translate-y-1/2">AHORA</div>
                            </div>
                        </div>

                        {/* Labels positioned absolutely */}
                        <div className="relative h-6 mt-1 w-full text-[10px] font-bold">
                            <div 
                                className="absolute transform -translate-x-1/2 flex flex-col items-center text-yellow-400"
                                style={{ left: `${sunrisePercent}%` }}
                            >
                                <ArrowRight size={10} className="-rotate-90 mb-0.5"/>
                                <span>{sunriseStr}</span>
                            </div>
                            <div 
                                className="absolute transform -translate-x-1/2 flex flex-col items-center text-orange-400"
                                style={{ left: `${sunsetPercent}%` }}
                            >
                                <ArrowRight size={10} className="-rotate-90 mb-0.5"/>
                                <span>{sunsetStr}</span>
                            </div>
                        </div>
                        
                        <div className="mt-4 flex items-center justify-between text-xs text-slate-300 bg-white/5 p-2 rounded">
                            <div className="flex items-center"><Sunrise size={14} className="text-yellow-400 mr-2"/> Amanecer</div>
                            <div className="font-mono">{astronomy.duration}h Luz</div>
                            <div className="flex items-center">Atardecer <Sunset size={14} className="text-orange-500 ml-2"/></div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="pb-24 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto">
                    
                    {/* SOS & Apps Buttons */}
                    <div className="grid grid-cols-2 gap-3 mb-6">
                        <button 
                            onClick={handleSOS}
                            className="bg-red-600 text-white p-4 rounded-xl shadow-lg flex flex-col items-center justify-center active:scale-95 transition-transform animate-pulse-slow"
                        >
                            <AlertTriangle size={32} className="mb-2" />
                            <span className="font-bold text-sm">SOS EMERGENCIA</span>
                            <span className="text-[10px] opacity-80 mt-1">Enviar UbicaciÃ³n</span>
                        </button>
                        
                        <div className="flex flex-col gap-2">
                             <button 
                                onClick={openMSCApp}
                                className="flex-1 bg-blue-900 text-white p-2 rounded-xl shadow flex items-center justify-center active:scale-95"
                            >
                                <Anchor size={20} className="mr-2" />
                                <span className="text-xs font-bold">App MSC</span>
                            </button>
                            <button 
                                onClick={openTranslator}
                                className="flex-1 bg-indigo-600 text-white p-2 rounded-xl shadow flex items-center justify-center active:scale-95"
                            >
                                <Camera size={20} className="mr-2" />
                                <span className="text-xs font-bold">Traductor Visual</span>
                            </button>
                        </div>
                    </div>

                    <h2 className="text-2xl font-bold text-fjord-500 mb-4">GuÃ­a Local</h2>

                    {/* Solar Chart */}
                    <div className="mb-8">
                        <h3 className="font-bold text-slate-700 mb-2 flex items-center"><Sun size={18} className="mr-2 text-orange-500"/> Ciclo Solar Hoy</h3>
                        {renderSolarChart()}
                    </div>

                    {/* Hourly Weather Forecast (07:00 - 18:00) */}
                    {hourlyForecast.length > 0 && (
                        <div className="mb-8">
                             <h3 className="font-bold text-slate-700 mb-4 flex items-center"><Clock size={18} className="mr-2 text-blue-500"/> Clima por Horas (07:00 - 18:00)</h3>
                             <div className="flex overflow-x-auto pb-4 space-x-3 snap-x">
                                {hourlyForecast.map((hour, idx) => (
                                    <div key={idx} className="flex-none w-20 bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex flex-col items-center justify-center snap-center">
                                        <span className="text-xs font-bold text-slate-400 mb-2">{hour.time}</span>
                                        <div className="mb-2 scale-125">{getWeatherIcon(hour.code)}</div>
                                        <span className="text-lg font-bold text-slate-800">{hour.temp}Â°</span>
                                        <div className="flex items-center text-[10px] text-blue-500 font-medium mt-1">
                                            <Droplets size={8} className="mr-1"/> {hour.precip}%
                                        </div>
                                    </div>
                                ))}
                             </div>
                        </div>
                    )}

                    {/* 5-Day Forecast */}
                    <div className="mb-8">
                         <h3 className="font-bold text-slate-700 mb-4 flex items-center"><CloudSun size={18} className="mr-2 text-blue-500"/> PronÃ³stico 5 DÃ­as</h3>
                         <div className="bg-white rounded-xl shadow-sm border border-slate-200 divide-y divide-slate-100">
                            {forecast.length > 0 ? forecast.map((day, i) => {
                                const date = new Date(day.date);
                                const dayName = date.toLocaleDateString('es-ES', { weekday: 'long' });
                                return (
                                    <div key={day.date} className="p-3 flex justify-between items-center">
                                        <span className="capitalize w-24 font-medium text-slate-700">{i===0 ? 'Hoy' : dayName}</span>
                                        <div className="flex items-center">
                                            {getWeatherIcon(day.code)}
                                            <span className="ml-2 text-sm text-slate-500">{day.code <= 3 ? 'Soleado' : 'Nublado'}</span>
                                        </div>
                                        <div className="text-sm font-mono font-bold text-slate-800">
                                            {Math.round(day.max)}Â° <span className="text-slate-400">/ {Math.round(day.min)}Â°</span>
                                        </div>
                                    </div>
                                )
                            }) : <div className="p-4 text-center text-slate-400">Cargando clima...</div>}
                         </div>
                    </div>
                    
                    {/* Pronunciation */}
                    <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><Volume2 size={18} className="mr-2"/> Diccionario ExprÃ©s</h3>
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                        {PRONUNCIATIONS.map((item, idx) => (
                        <div key={item.word} className={`p-4 flex justify-between items-center ${idx !== PRONUNCIATIONS.length - 1 ? 'border-b border-slate-50' : ''}`}>
                            <div>
                                <div className="flex items-baseline space-x-2">
                                    <span className="font-bold text-lg text-fjord-700">{item.word}</span>
                                    <span className="text-xs text-slate-400 font-mono bg-slate-100 px-1 rounded">{item.simplified}</span>
                                </div>
                                <p className="text-xs text-slate-500 mt-1 italic">{item.meaning}</p>
                            </div>
                            <button 
                                onClick={() => playAudio(item.word)}
                                className={`p-3 rounded-full transition-colors ${playing === item.word ? 'bg-emerald-100 text-emerald-600 scale-110' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}`}
                            >
                            <Volume2 size={20} />
                            </button>
                        </div>
                        ))}
                    </div>

                     {/* Footer */}
                     <div className="text-center py-8 text-slate-400 text-xs">
                        <p className="font-medium">FlÃ¥m Guide 2026</p>
                        <p>Actualizado el {UPDATE_DATE}</p>
                        <p className="mt-1">Â© 2025 - 2026 Gonzalo Arenas de la Hoz</p>
                    </div>
                </div>
            );
        };

        const MapComponent = ({ activities, userLocation, focusedLocation }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const layersRef = useRef([]);

            useEffect(() => {
                if (!mapContainerRef.current || mapInstanceRef.current) return;
                const map = L.map(mapContainerRef.current).setView([60.8638, 7.1187], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
                mapInstanceRef.current = map;
                return () => { map.remove(); mapInstanceRef.current = null; };
            }, []);

            useEffect(() => {
                const map = mapInstanceRef.current;
                if (!map) return;
                
                layersRef.current.forEach(l => l.remove());
                layersRef.current = [];

                // Custom Icons
                const createIcon = (color) => L.divIcon({
                    className: 'custom-pin',
                    html: `<div style="background-color: ${color}; width: 24px; height: 24px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid white; box-shadow: 2px 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;"><div style="width: 8px; height: 8px; background: white; border-radius: 50%; transform: rotate(45deg);"></div></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 24],
                    popupAnchor: [0, -24]
                });

                activities.forEach(act => {
                    const marker = L.marker([act.coords.lat, act.coords.lng], { icon: createIcon('#2A5B87') })
                        .addTo(map).bindPopup(`<b>${act.title}</b><br/>${act.locationName}`);
                    layersRef.current.push(marker);

                    if (act.endCoords) {
                         const endMarker = L.marker([act.endCoords.lat, act.endCoords.lng], { icon: createIcon('#3A7D44') })
                            .addTo(map).bindPopup(`<b>Fin: ${act.title}</b>`);
                        layersRef.current.push(endMarker);
                        const polyline = L.polyline([[act.coords.lat, act.coords.lng], [act.endCoords.lat, act.endCoords.lng]], { color: '#2A5B87', weight: 4, opacity: 0.6, dashArray: '10, 10' }).addTo(map);
                        layersRef.current.push(polyline);
                    }
                });

                if (userLocation) {
                    const userMarker = L.circleMarker([userLocation.lat, userLocation.lng], { radius: 8, fillColor: '#3b82f6', color: '#fff', weight: 3, fillOpacity: 1 }).addTo(map);
                    layersRef.current.push(userMarker);
                }
            }, [activities, userLocation]);

            useEffect(() => {
                if(mapInstanceRef.current && focusedLocation) {
                    mapInstanceRef.current.setView([focusedLocation.lat, focusedLocation.lng], 18, { animate: true, duration: 1.5 });
                }
            }, [focusedLocation]);

            return <div ref={mapContainerRef} className="w-full h-full bg-slate-100" />;
        };

        const App = () => {
            const [itinerary, setItinerary] = useState(INITIAL_ITINERARY);
            const [activeTab, setActiveTab] = useState('timeline');
            const [userLocation, setUserLocation] = useState(null);
            const [mapFocus, setMapFocus] = useState(null);
            const [selectedActivity, setSelectedActivity] = useState(null);
            const [countdown, setCountdown] = useState('');

            useEffect(() => {
                if ('geolocation' in navigator) {
                    const id = navigator.geolocation.watchPosition(
                        p => setUserLocation({ lat: p.coords.latitude, lng: p.coords.longitude }),
                        e => console.warn(e),
                        { enableHighAccuracy: true }
                    );
                    return () => navigator.geolocation.clearWatch(id);
                }
            }, []);

            useEffect(() => {
                const interval = setInterval(() => {
                    const now = new Date();
                    // Changed to count down to ONBOARD_TIME for safety
                    const [h, m] = ONBOARD_TIME.split(':').map(Number);
                    const target = new Date(); target.setHours(h, m, 0, 0);
                    const diff = target - now;
                    
                    if (diff <= 0) setCountdown("Â¡A BORDO!");
                    else {
                        const hr = Math.floor(diff/(1000*60*60));
                        const mn = Math.floor((diff%(1000*60*60))/(1000*60));
                        const sc = Math.floor((diff%(1000*60))/1000);
                        setCountdown(`${hr}h ${mn}m ${sc}s`);
                    }
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            const handleToggleComplete = (id) => {
                setItinerary(prev => prev.map(a => a.id === id ? { ...a, completed: !a.completed } : a));
            };

            const handleLocate = (c1, c2) => {
                setMapFocus(c1);
                setActiveTab('map');
            };

            return (
                <div className="flex flex-col h-screen bg-slate-50 text-slate-900 font-sans overflow-hidden select-none">
                    <header className="bg-fjord-900 text-white p-3 shadow-md z-20 flex justify-between items-center shrink-0">
                        <div className="flex items-center">
                            <Anchor className="mr-2 text-sunset-500" size={20} />
                            <div>
                                <h1 className="font-bold text-sm leading-none">Todos a Bordo: {ONBOARD_TIME}</h1>
                                <p className="text-[10px] text-fjord-200">Salida Barco: {SHIP_DEPARTURE_TIME}</p>
                            </div>
                        </div>
                        <div className="text-right font-mono font-bold text-lg text-sunset-500">{countdown}</div>
                    </header>

                    <main className="flex-1 overflow-hidden relative">
                        {activeTab === 'timeline' && <div className="h-full overflow-y-auto"><Timeline itinerary={itinerary} onToggleComplete={handleToggleComplete} onLocate={handleLocate} userLocation={userLocation} onSelectActivity={setSelectedActivity} /></div>}
                        {activeTab === 'map' && <MapComponent activities={itinerary} userLocation={userLocation} focusedLocation={mapFocus} />}
                        {activeTab === 'budget' && <Budget itinerary={itinerary} />}
                        {activeTab === 'guide' && <Guide userLocation={userLocation} />}
                    </main>

                    {selectedActivity && <ActivityDetailModal activity={selectedActivity} onClose={() => setSelectedActivity(null)} />}

                    <nav className="bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-30 pb-safe shrink-0">
                        <div className="flex justify-around items-center h-16">
                            {[
                                { id: 'timeline', icon: CalendarClock, label: 'Itinerario' },
                                { id: 'map', icon: MapIcon, label: 'Mapa' },
                                { id: 'budget', icon: Wallet, label: 'Gastos' },
                                { id: 'guide', icon: BookOpen, label: 'GuÃ­a' }
                            ].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center w-full h-full justify-center transition-colors ${activeTab === tab.id ? 'text-fjord-600' : 'text-slate-300'}`}>
                                    <tab.icon size={24} strokeWidth={activeTab === tab.id ? 2.5 : 2} />
                                    <span className="text-[10px] mt-1 font-bold">{tab.label}</span>
                                </button>
                            ))}
                        </div>
                    </nav>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>